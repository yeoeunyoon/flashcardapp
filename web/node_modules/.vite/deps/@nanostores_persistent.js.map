{
  "version": 3,
  "sources": ["../../.pnpm/@nanostores+persistent@0.10.2_nanostores@0.10.3/node_modules/@nanostores/persistent/index.js"],
  "sourcesContent": ["import { atom, map, onMount } from 'nanostores'\n\nlet identity = a => a\nlet storageEngine = {}\nlet eventsEngine = { addEventListener() {}, removeEventListener() {} }\n\nfunction testSupport() {\n  try {\n    return typeof localStorage !== 'undefined'\n    /* c8 ignore next 4 */\n  } catch {\n    // In Privacy Mode access to localStorage will return error\n    return false\n  }\n}\nif (testSupport()) {\n  storageEngine = localStorage\n}\n\nexport let windowPersistentEvents = {\n  addEventListener(key, listener, restore) {\n    window.addEventListener('storage', listener)\n    window.addEventListener('pageshow', restore)\n  },\n  removeEventListener(key, listener, restore) {\n    window.removeEventListener('storage', listener)\n    window.removeEventListener('pageshow', restore)\n  }\n}\n\nif (typeof window !== 'undefined') {\n  eventsEngine = windowPersistentEvents\n}\n\nexport function setPersistentEngine(storage, events) {\n  storageEngine = storage\n  eventsEngine = events\n}\n\nexport function persistentAtom(name, initial = undefined, opts = {}) {\n  let encode = opts.encode || identity\n  let decode = opts.decode || identity\n\n  let store = atom(initial)\n\n  let set = store.set\n  store.set = newValue => {\n    if (typeof newValue === 'undefined') {\n      delete storageEngine[name]\n    } else {\n      storageEngine[name] = encode(newValue)\n    }\n    set(newValue)\n  }\n\n  function listener(e) {\n    if (e.key === name) {\n      if (e.newValue === null) {\n        set(undefined)\n      } else {\n        set(decode(e.newValue))\n      }\n    } else if (!storageEngine[name]) {\n      set(undefined)\n    }\n  }\n\n  function restore() {\n    store.set(storageEngine[name] ? decode(storageEngine[name]) : initial)\n  }\n\n  onMount(store, () => {\n    restore()\n    if (opts.listen !== false) {\n      eventsEngine.addEventListener(name, listener, restore)\n      return () => {\n        eventsEngine.removeEventListener(name, listener, restore)\n      }\n    }\n  })\n\n  return store\n}\n\nexport function persistentMap(prefix, initial = {}, opts = {}) {\n  let encode = opts.encode || identity\n  let decode = opts.decode || identity\n\n  let store = map()\n\n  let setKey = store.setKey\n  let storeKey = (key, newValue) => {\n    if (typeof newValue === 'undefined') {\n      if (opts.listen !== false && eventsEngine.perKey) {\n        eventsEngine.removeEventListener(prefix + key, listener, restore)\n      }\n      delete storageEngine[prefix + key]\n    } else {\n      if (\n        opts.listen !== false &&\n        eventsEngine.perKey &&\n        !(key in store.value)\n      ) {\n        eventsEngine.addEventListener(prefix + key, listener, restore)\n      }\n      storageEngine[prefix + key] = encode(newValue)\n    }\n  }\n\n  store.setKey = (key, newValue) => {\n    storeKey(key, newValue)\n    setKey(key, newValue)\n  }\n\n  let set = store.set\n  store.set = function (newObject) {\n    for (let key in newObject) {\n      storeKey(key, newObject[key])\n    }\n    for (let key in store.value) {\n      if (!(key in newObject)) {\n        storeKey(key, undefined)\n      }\n    }\n    set(newObject)\n  }\n\n  function listener(e) {\n    if (!e.key) {\n      set({})\n    } else if (e.key.startsWith(prefix)) {\n      if (e.newValue === null) {\n        setKey(e.key.slice(prefix.length), undefined)\n      } else {\n        setKey(e.key.slice(prefix.length), decode(e.newValue))\n      }\n    }\n  }\n\n  function restore() {\n    let data = { ...initial }\n    for (let key in storageEngine) {\n      if (key.startsWith(prefix)) {\n        data[key.slice(prefix.length)] = decode(storageEngine[key])\n      }\n    }\n    for (let key in data) {\n      store.setKey(key, data[key])\n    }\n  }\n\n  onMount(store, () => {\n    restore()\n    if (opts.listen !== false) {\n      eventsEngine.addEventListener(prefix, listener, restore)\n      return () => {\n        eventsEngine.removeEventListener(prefix, listener, restore)\n        for (let key in store.value) {\n          eventsEngine.removeEventListener(prefix + key, listener, restore)\n        }\n      }\n    }\n  })\n\n  return store\n}\n\nlet testStorage = {}\nlet testListeners = []\n\nexport function useTestStorageEngine() {\n  setPersistentEngine(testStorage, {\n    addEventListener(key, cb) {\n      testListeners.push(cb)\n    },\n    removeEventListener(key, cb) {\n      testListeners = testListeners.filter(i => i !== cb)\n    }\n  })\n}\n\nexport function setTestStorageKey(key, newValue) {\n  if (typeof newValue === 'undefined') {\n    delete testStorage[key]\n  } else {\n    testStorage[key] = newValue\n  }\n  let event = { key, newValue }\n  for (let listener of testListeners) {\n    listener(event)\n  }\n}\n\nexport function getTestStorage() {\n  return testStorage\n}\n\nexport function cleanTestStorage() {\n  for (let i in testStorage) {\n    setTestStorageKey(i, undefined)\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
